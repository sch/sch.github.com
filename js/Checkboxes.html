<script>
  import { onMount } from "svelte";
  import throttle from "lodash.throttle";

  import { drawText, emptyCanvas, flipBit } from "./canvas";
  import { randomWalk, Point, Dimensions } from "./graphics";

  let element;
  let points = [];
  let clientWidth = 10;
  let clientHeight = 10;
  let sampledDimensions = new Dimensions(10, 10);
  let canvas = emptyCanvas(sampledDimensions.width, sampledDimensions.height);

  $: if (element) {
    const containerDimensions = new Dimensions(clientWidth, clientHeight);
    const checkboxElement = element.querySelector("label");
    const checkboxDimensions = elementDimensions(checkboxElement);
    sampledDimensions = containerDimensions.sample(checkboxDimensions);
    canvas = emptyCanvas(sampledDimensions.width, sampledDimensions.height);
  }

  onMount(function() {
    draw();

    var interval = setInterval(tick, 1500);

    var el = document.querySelector(".js-Checkboxes");

    if (el && el.classList.contains("isPaused")) {
      el.classList.remove("isPaused");
    }

    return function cleanup() {
      clearInterval(interval);
    };
  });

  function draw() {
    if (sampledDimensions.width > 38) {
      canvas = drawText(canvas, "adrian", new Point(2, 2));
      canvas = drawText(canvas, "schaedle", new Point(2, 9));
    }

    points.forEach(point => flipBit(canvas, point.x, point.y));
    points = points;
  }

  function elementDimensions(element) {
    return new Dimensions(element.clientWidth || 0, element.clientHeight || 0);
  }

  function tick() {
    points = points.map(point => randomWalk(point, sampledDimensions));
    draw();
  }

  function addPoint(x, y) {
    return function() {
      var newPoint = new Point(x, y);
      points.push(newPoint);
    };
  }
</script>

<style>
  .CheckboxCanvas {
    box-sizing: border-box;
    overflow: hidden;
    width: 100%;
    height: 100%;
  }

  .Info {
    background-color: white;
    z-index: 1;
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 10px;
  }

  .CheckboxCanvas div {
    margin: 0;
    line-height: 0;
  }

  .CheckboxCanvas label {
    padding: 3px 2px;
    display: inline-block;
  }

  .CheckboxCanvas input {
    margin: 0;
    padding: 0;
  }
</style>

<div
  bind:this="{element}"
  bind:clientWidth="{clientWidth}"
  bind:clientHeight="{clientHeight}"
  class="CheckboxCanvas"
>
  {#each canvas as row, y}
  <div>
    {#each row as checked, x}
    <label>
      <input type="checkbox" {checked} on:change="{addPoint(x, y)}" />
    </label>
    {/each}
  </div>
  {/each}
</div>
