<div ref:element class="CheckboxCanvas">
  {#each canvas as row, y}
  <div>
    {#each row as column, x}
    <label>
      <input type="checkbox" checked={column} on:change="addPoint(x, y)"/>
    </label>
    {/each}
  </div>
  {/each}
</div>

<style>
.CheckboxCanvas {
  box-sizing: border-box;
  overflow: hidden;
  width: 100%;
  height: 100%;
}

.CheckboxCanvas div {
  margin: 0;
  line-height: 0;
}

.CheckboxCanvas label {
  padding: 1px;
  display: inline-block;
}

.CheckboxCanvas input {
  margin: 0;
  padding: 0;
}
</style>

<script>
import { drawText, emptyCanvas, createPoint, flipBit } from "./canvas"
import { randomWalk, Point, Dimensions } from "./graphics"
import throttle from "lodash.throttle"

function viewportDimensions () {
  var { clientWidth, clientHeight } = document.documentElement
  var width = Math.max(clientWidth, window.innerWidth || 0);
  var height = Math.max(clientHeight, window.innerHeight || 0);
  return new Dimensions(width, height)
}

function elementDimensions (element) {
  return new Dimensions(element.clientWidth || 0, element.clientHeight || 0)
}

function calculateCanvasDimensions (containerElement, checkboxElement) {
  const containerDimensions = elementDimensions(containerElement)
  const checkboxDimensions = elementDimensions(checkboxElement)
  const adjustedDimensions = containerDimensions.clamp(viewportDimensions())
  return adjustedDimensions.sample(checkboxDimensions)
}

function randomInRange (upperLimit) {
  return Math.floor(Math.random() * upperLimit)
}

export default {
  data: function () {
    return {
      width: 100,
      height: 50,
      points: [],
      text: "adrian\nschaedle"
    }
  },

  oncreate: function () {
    window.addEventListener("resize", this.resize.bind(this))
    setInterval(this.tick.bind(this), 1500)
    this.resize()

    var el = document.querySelector(".js-Checkboxes");
    if (el && el.classList.contains("isPaused")) {
      el.classList.remove("isPaused")
    }
  },

  ondestroy: function () {
    window.removeEventListener("resize", this.resize)
  },

  computed: {
    canvas: function ({ width, height, text, points }) {
      var canvas = emptyCanvas(width, height)
      if (width > 38) {
        canvas = drawText(canvas, "adrian", createPoint(2, 2))
        canvas = drawText(canvas, "schaedle", createPoint(2, 9))
      }
      points.forEach((point) => flipBit(canvas, point.x, point.y))
      return canvas
    }
  },

  methods: {
    resize: throttle(function () {
      var element = this.refs.element.parentNode
      // var element = this.refs.element.parentNode
      var checkbox = element.querySelector("label")
      this.set(calculateCanvasDimensions(element, checkbox))
    }, 500),

    addPoint (x, y) {
      var newPoint = new Point(x, y)
      var { points } = this.get()
      points.push(newPoint)
      this.set({ points })
    },

    tick () {
      var { points, width, height} = this.get()
      var dimensions = new Dimensions(width, height)
      this.set({
        points: points.map((point) => randomWalk(point, dimensions))
      })
    }
  }
}
</script>
