<div bind:this="{element}" class="CheckboxCanvas">
  {#each canvas as row, y}
  <div>
    {#each row as checked, x}
    <label>
      <input type="checkbox" {checked} on:change={() => addPoint(x, y)}/>
    </label>
    {/each}
  </div>
  {/each}
</div>

<svelte:window on:resize="{resize}" />

<style>
  .CheckboxCanvas {
    box-sizing: border-box;
    overflow: hidden;
    width: 100%;
    height: 100%;
  }

  .CheckboxCanvas div {
    margin: 0;
    line-height: 0;
  }

  .CheckboxCanvas label {
    padding: 1px;
    display: inline-block;
  }

  .CheckboxCanvas input {
    margin: 0;
    padding: 0;
  }
</style>

<script>
  import { onMount } from "svelte";
  import { drawText, emptyCanvas, createPoint, flipBit } from "./canvas";
  import { randomWalk, Point, Dimensions } from "./graphics";
  import throttle from "lodash.throttle";

  let element;
  let points = [];
  let canvas = emptyCanvas(100, 50);

  function draw() {
    if (width > 38) {
      canvas = drawText(canvas, "adrian", createPoint(2, 2));
      canvas = drawText(canvas, "schaedle", createPoint(2, 9));
    }

    points.forEach(point => flipBit(canvas, point.x, point.y));
  }

  function viewportDimensions() {
    var { clientWidth, clientHeight } = document.documentElement;
    var width = Math.max(clientWidth, window.innerWidth || 0);
    var height = Math.max(clientHeight, window.innerHeight || 0);
    return new Dimensions(width, height);
  }

  function elementDimensions(element) {
    return new Dimensions(element.clientWidth || 0, element.clientHeight || 0);
  }

  function calculateCanvasDimensions(containerElement, checkboxElement) {
    const containerDimensions = elementDimensions(containerElement);
    const checkboxDimensions = elementDimensions(checkboxElement);
    const adjustedDimensions = containerDimensions.clamp(viewportDimensions());
    return adjustedDimensions.sample(checkboxDimensions);
  }

  function randomInRange(upperLimit) {
    return Math.floor(Math.random() * upperLimit);
  }

  function resize() {
    var checkbox = element.querySelector("label");
    var dimensions = calculateCanvasDimensions(element.parentNode, checkbox);
    canvas = emptyCanvas(width, height);
  }

  function tick() {
    var dimensions = new Dimensions(width, height);
    points = points.map(point => randomWalk(point, dimensions));
    draw();
  }

  onMount(function() {
    resize();
    draw();

    var interval = setInterval(tick, 1500);

    var el = document.querySelector(".js-Checkboxes");

    if (el && el.classList.contains("isPaused")) {
      el.classList.remove("isPaused");
    }

    return function cleanup() {
      clearInterval(interval);
    };
  });

  function addPoint(x, y) {
    var newPoint = new Point(x, y);
    points.push(newPoint);
  }
</script>
